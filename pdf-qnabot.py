# -*- coding: utf-8 -*-
"""pdf-qnabot

Automatically generated by Colab.

Original file is located at
    https://colab.research.google.com/drive/1fj1PtGdnnAip1fMVXpCiMv_BVrS6hKEm
"""

#!pip install streamlit langchain langchain_community openai PyPDF2 faiss-cpu tiktoken

import streamlit as st
import PyPDF2
import openai
from langchain.chains.question_answering import load_qa_chain
from langchain.llms import OpenAI
from langchain.vectorstores import FAISS
from langchain.embeddings.openai import OpenAIEmbeddings
from io import StringIO
import os

# OpenAI API 키 가져오기
openai_api_key = st.secrets["openai_api_key"]
os.environ["OPENAI_API_KEY"] = openai_api_key

# Streamlit 애플리케이션 설정
st.title("PDF 기반 Q&A 챗봇")
st.write("PDF 문서를 업로드하고 질문을 입력하세요.")

# PDF 파일 업로드
uploaded_file = st.file_uploader("PDF 파일 업로드", type=["pdf"])

def summarize_pdf(file):
    pdf_reader = PyPDF2.PdfReader(file)
    summary = []
    for page_num in range(min(3, len(pdf_reader.pages))):  # 최대 3 페이지까지 요약
        page = pdf_reader.pages[page_num]
        summary.append(page.extract_text())
    return "\n".join(summary[:3])  # 요약 내용을 3줄로 제한

def embed_pdf(file):
    pdf_reader = PyPDF2.PdfReader(file)
    text = ""
    for page_num in range(len(pdf_reader.pages)):
        page = pdf_reader.pages[page_num]
        text += page.extract_text()
    return text

if uploaded_file is not None:
    st.write("PDF 파일 요약:")
    summary = summarize_pdf(uploaded_file)
    st.write(summary)
    
    # PDF 내용 임베딩 및 벡터 DB에 저장
    pdf_text = embed_pdf(uploaded_file)
    embeddings = OpenAIEmbeddings()
    vectorstore = FAISS.from_texts([pdf_text], embeddings)
    
    question = st.text_input("질문을 입력하세요:")
    
    if question:
        # langchain을 사용하여 Q&A 실행
        llm = OpenAI()
        qa_chain = load_qa_chain(llm)
        docs = vectorstore.similarity_search(question)
        answer = qa_chain({"question": question, "context": docs[0].page_content})
        st.write("답변:")
        st.write(answer['answer'])

# 로컬에서 실행하려면 아래 코드를 사용하세요.
# if __name__ == "__main__":
#     st.run()
